name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        cuda: ["13.1.0", "12.8.1", "11.8.0"]

    steps:
      - uses: actions/checkout@v6

      - name: Select CUDA arch list
        run: |
          CUDA="${{ matrix.cuda }}"
          if [[ "$CUDA" == 13.* ]]; then
            echo 'CUDA_ARCHS=75;86;89;120' >> "$GITHUB_ENV"
          else
            echo 'CUDA_ARCHS=75;86;89' >> "$GITHUB_ENV"
          fi

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.20
        with:
          key: ${{ runner.os }}-cuda${{ matrix.cuda }}-${{ env.BUILD_TYPE }}
          restore-keys: |
            ${{ runner.os }}-cuda${{ matrix.cuda }}-
          max-size: 1G

      - name: Install CUDA Toolkit (network)
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda
        with:
          cuda: ${{ matrix.cuda }}
          method: network
          sub-packages: '["toolkit","nvml-dev"]'
          log-file-suffix: "linux-cuda${{ matrix.cuda }}.txt"

      - name: Verify CUDA installation
        run: |
          nvcc --version
          echo "CUDA_PATH=$CUDA_PATH"

      - name: Configure CMake
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE="${BUILD_TYPE}" \
            -DCMAKE_CUDA_ARCHITECTURES="${CUDA_ARCHS}" \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CUDA_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build --parallel

      - name: Package binary
        run: |
          tar -czf build/gpu-burn-linux-cuda${{ matrix.cuda }}.tar.gz -C build gpu-burn

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: gpu-burn-linux-cuda${{ matrix.cuda }}
          path: build/gpu-burn-linux-cuda${{ matrix.cuda }}.tar.gz

  build-windows:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        cuda: ["13.1.0", "12.8.1"]

    steps:
      - uses: actions/checkout@v6

      - name: Select CUDA arch list
        shell: pwsh
        run: |
          $cuda = "${{ matrix.cuda }}"
          if ($cuda -like "13.*") {
            "CUDA_ARCHS=75;86;89;120" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          } else {
            "CUDA_ARCHS=75;86;89" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          }

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda
        with:
          cuda: ${{ matrix.cuda }}
          method: network
          log-file-suffix: "windows-cuda${{ matrix.cuda }}.txt"

      - name: Verify CUDA installation
        shell: pwsh
        run: |
          nvcc --version
          "CUDA_PATH=$env:CUDA_PATH"

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -S . -B build `
            -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" `
            -DCMAKE_CUDA_ARCHITECTURES="$env:CUDA_ARCHS" `
            -DCMAKE_CUDA_FLAGS="-Xcompiler=/Zc:preprocessor"

      - name: Build
        shell: pwsh
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Package binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          $exe = if (Test-Path build/Release/gpu-burn.exe) { "build/Release/gpu-burn.exe" } else { "build/gpu-burn.exe" }
          Copy-Item $exe -Destination "dist/gpu-burn-windows-cuda${{ matrix.cuda }}.exe"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: gpu-burn-windows-cuda${{ matrix.cuda }}
          path: dist/gpu-burn-windows-cuda${{ matrix.cuda }}.exe

  release-assets:
    if: github.ref_type == 'tag'
    runs-on: ubuntu-slim
    needs: [build-linux, build-windows]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist

      - name: List artifacts
        run: ls -R dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: ${{ github.ref_name }}
          name: GPU-Burn ${{ github.ref_name }}
          files: |
            dist/**/*.tar.gz
            dist/**/*.exe
          body: |
            ## GPU-Burn - CUDA Stress Test

            A GPU testing tool with NVML monitoring, modes (GEMM, Compute, Memory), and cross-platform support.

            ### Downloads

            Binaries are **dynamically linked** - download the version matching your installed CUDA toolkit.

            | Platform | CUDA Version | File |
            | ---------- | -------------- | ------ |
            | Linux | 13.1 | `gpu-burn-linux-cuda13.1.0.tar.gz` |
            | Linux | 12.8 | `gpu-burn-linux-cuda12.8.1.tar.gz` |
            | Linux | 11.8 | `gpu-burn-linux-cuda11.8.0.tar.gz` |
            | Windows | 13.1 | `gpu-burn-windows-cuda13.1.0.exe` |
            | Windows | 12.8 | `gpu-burn-windows-cuda12.8.1.exe` |

            Check your CUDA version: `nvcc --version` or `nvidia-smi`

            ### Quick Start

            ```bash
            # Run stress test for 60 seconds
            ./gpu-burn 60

            # With verbose monitoring
            ./gpu-burn -v 120

            # Compute stress mode
            ./gpu-burn -mode compute 60

            # Memory stress mode
            ./gpu-burn -mode memory 60
            ```

            See [README](https://github.com/intel00000/gpu-burn#readme) for full documentation.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
